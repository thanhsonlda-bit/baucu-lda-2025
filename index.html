<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phiếu bầu – Chi đoàn Khối Văn phòng (2025–2027)</title>
<style>
  :root{--c1:#0ea5e9;--ok:#16a34a;--err:#dc2626;--muted:#64748b;--bg:#f8fafc;--bd:#e5e7eb}
  *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:0 auto;padding:16px;line-height:1.45}
  header{margin:4px 0 12px} h1{font-size:22px;margin:0 0 6px}
  .card{border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0;background:#fff}
  .row{display:grid;grid-template-columns:1fr 140px 140px;gap:8px;align-items:center}
  .row.head{font-weight:600;background:var(--bg);border-radius:8px;padding:8px}
  .name{padding:8px} .opt{text-align:center}
  button{padding:10px 16px;border:0;border-radius:10px;background:var(--c1);color:#fff;font-weight:600;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:14px} .ok{color:var(--ok)} .err{color:var(--err)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid var(--bd);padding:8px;text-align:left}
  th{background:var(--bg)} .bar{height:10px;border-radius:6px;background:#e5e7eb;position:relative;overflow:hidden}
  .bar>span{position:absolute;left:0;top:0;bottom:0;background:#22c55e}
  .pill{padding:2px 8px;border-radius:999px;background:#f1f5f9;font-size:12px}
  .rowActions{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>PHIẾU BẦU ĐẠI BIỂU DỰ ĐẠI HỘI ĐOÀN THANH NIÊN CÔNG TY 2025–2030</h1>
  <div class="muted">Chi đoàn Khối Văn phòng – Lâm Đồng</div>
</header>

<!-- Vùng A: FORM BỎ PHIẾU -->
<section id="sec-form" class="card">
  <div class="row head">
    <div class="name">Ứng viên</div><div class="opt">Đồng ý</div><div class="opt">Không đồng ý</div>
  </div>

  <!-- Đại biểu chính -->
  <div class="row"><div class="name">1. TRẦN THANH SƠN</div>
    <label class="opt"><input type="radio" name="SON_1" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="SON_1" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">2. THÂN NGUYỄN MINH HUY</div>
    <label class="opt"><input type="radio" name="HUY_2" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="HUY_2" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">3. NGUYỄN DƯƠNG MAI NHUNG</div>
    <label class="opt"><input type="radio" name="NHUNG_3" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="NHUNG_3" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">4. TRẦN THANH CẢNH</div>
    <label class="opt"><input type="radio" name="CANH_4" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="CANH_4" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">5. VÕ VĂN HIẾU</div>
    <label class="opt"><input type="radio" name="HIEU_5" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="HIEU_5" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">6. NGUYỄN THỊ THÙY TRANG</div>
    <label class="opt"><input type="radio" name="TRANG_6" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="TRANG_6" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">7. LÊ HỮU MINH</div>
    <label class="opt"><input type="radio" name="MINH_7" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="MINH_7" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">8. THÁI THỊ CHÂU</div>
    <label class="opt"><input type="radio" name="CHAU_8" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="CHAU_8" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">9. TRẦN DANH KHOA</div>
    <label class="opt"><input type="radio" name="KHOA_9" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="KHOA_9" value="Không đồng ý"></label></div>
  <div class="row"><div class="name">10. NGUYỄN ANH TRẠNG</div>
    <label class="opt"><input type="radio" name="TRANG_10" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="TRANG_10" value="Không đồng ý"></label></div>

  <hr style="margin:16px 0;border:none;border-top:1px dashed var(--bd)" />
  <div class="row head"><div class="name">Dự khuyết</div><div></div><div></div></div>
  <div class="row"><div class="name">1. NGUYỄN MINH TRÍ</div>
    <label class="opt"><input type="radio" name="TRI_DK_1" value="Đồng ý" required></label>
    <label class="opt"><input type="radio" name="TRI_DK_1" value="Không đồng ý"></label></div>

  <div style="margin-top:16px">
    <label class="muted">Mã định danh (nếu áp dụng chống trùng): </label>
    <input id="token" type="text" placeholder="Nhập mã được cấp (nếu có)"
           style="padding:8px;border:1px solid var(--bd);border-radius:8px;width:260px">
  </div>

  <div style="margin-top:16px;display:flex;gap:10px;align-items:center">
    <button id="btnSubmit">Gửi phiếu</button>
    <span id="msg" class="muted"></span>
  </div>
</section>

<!-- Vùng B: TỶ LỆ (ẩn mặc định) -->
<section id="sec-results" class="card hidden">
  <h2 style="margin:0 0 8px">TỶ LỆ PHIẾU</h2>
  <div class="muted">Tự động cập nhật mỗi 5 giây</div>
  <div class="rowActions">
    <div>Tổng số phiếu: <span id="total" class="pill">0</span></div>
    <button id="btnClear" title="Nhập mật khẩu để xóa dữ liệu">XÓA DỮ LIỆU</button>
    <span id="status" class="muted"></span>
  </div>
  <table id="tbl">
    <thead><tr><th>Ứng viên</th><th>Đồng ý</th><th>Không đồng ý</th><th>% Đồng ý</th><th>Biểu đồ</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<script>
  // === CẤU HÌNH ===
  var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4RUMQ0WKFyKJJCv2bZhXEwUNythkLUOe1NMG_gI44K9bDC-fssolk36iLbfHLIilK/exec";
  // ===============

  // DOM
  var secForm = document.getElementById('sec-form');
  var secRes  = document.getElementById('sec-results');
  var msg     = document.getElementById('msg');
  var btn     = document.getElementById('btnSubmit');

  // Nếu đã vote -> nhảy thẳng sang bảng kết quả
  if (localStorage.getItem("voted")==="1") showResults();

  // Gửi phiếu (x-www-form-urlencoded để không bị preflight/CORS)
  btn.addEventListener('click', function(){
    btn.disabled = true; msg.textContent = "Đang gửi..."; msg.className = "muted";
    try{
      var data = collectForm();
      if(!data) { btn.disabled=false; return; }

      var body = new URLSearchParams(data).toString();
      fetch(SCRIPT_URL, { method:'POST', body: body })
        .then(function(res){
          if(!res.ok) throw new Error("HTTP "+res.status);
          localStorage.setItem("voted","1");
          showResults();               // chuyển nội trang
        })
        .catch(function(err){
          console.error(err);
          msg.textContent = "Không gửi được phiếu: " + String(err);
          msg.className = "err";
          btn.disabled = false;
        });
    }catch(err){
      console.error(err);
      msg.textContent = "Lỗi trình duyệt khi gửi phiếu."; msg.className="err";
      btn.disabled=false;
    }
  });

  function collectForm(){
    // Lấy giá trị các radio; nếu thiếu required thì báo
    function valOf(name){ var el = document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:""; }
    var names = ["SON_1","HUY_2","NHUNG_3","CANH_4","HIEU_5","TRANG_6","MINH_7","CHAU_8","KHOA_9","TRANG_10","TRI_DK_1"];
    for (var i=0;i<names.length;i++){
      if (!valOf(names[i])) { msg.textContent="Vui lòng chọn đủ tất cả ứng viên."; msg.className="err"; return null; }
    }
    var data = {};
    for (var j=0;j<names.length;j++){ data[names[j]] = valOf(names[j]); }
    data.token = document.getElementById('token').value || "";
    data.submitted_at = new Date().toISOString();
    return data;
  }

  // ====== BẢNG TỶ LỆ ======
  var TBL = document.querySelector("#tbl tbody");
  var TOTAL = document.getElementById("total");
  var STATUS = document.getElementById("status");
  var BTN_CLEAR = document.getElementById("btnClear");
  var timer = null;

  function showResults(){
    secForm.classList.add('hidden');
    secRes.classList.remove('hidden');
    history.pushState(null,"",location.href);     // chặn back
    window.addEventListener("popstate", function(){ secForm.classList.add('hidden'); secRes.classList.remove('hidden'); });
    loadSummary();
    if (timer) clearInterval(timer);
    timer = setInterval(loadSummary, 5000);
  }

  async function loadSummary(){
    try{
      STATUS.textContent = "Đang tải...";
      var res = await fetch(SCRIPT_URL + "?summary=1", {method:"GET"});
      var js = await res.json();
      if (!js.ok) throw new Error("Không lấy được dữ liệu");
      var total = js.data.total, items = js.data.items;
      TOTAL.textContent = total;
      TBL.innerHTML = "";
      items.forEach(function(it){
        var pct = Math.round((it.pct||0)*100);
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>"+it.name+"</td>"+
          "<td>"+it.agree+"</td>"+
          "<td>"+it.disagree+"</td>"+
          "<td>"+pct+"%</td>"+
          "<td><div class='bar'><span style='width:"+pct+"%'></span></div></td>";
        TBL.appendChild(tr);
      });
      STATUS.textContent = "Cập nhật: " + new Date().toLocaleTimeString();
    }catch(err){
      console.error(err); STATUS.textContent = "Lỗi tải dữ liệu";
    }
  }

  BTN_CLEAR.addEventListener("click", async function(){
    var pw = prompt("Nhập mật khẩu để XÓA DỮ LIỆU:");
    if (pw == null) return;
    try{
      STATUS.textContent = "Đang xóa...";
      var res = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({op:"clear", pw: pw})
      });
      var js = await res.json();
      if (!js.ok) throw new Error(js.error || "Xóa thất bại");
      STATUS.textContent = "Đã xóa dữ liệu.";
      await loadSummary();
    }catch(err){
      STATUS.textContent = "Sai mật khẩu hoặc lỗi xóa.";
    }
  });
</script>
</body>
</html>
